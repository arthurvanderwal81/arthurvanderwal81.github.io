<!-- https://sensor-js.xyz/demo.html -->
<!-- accelerationIncludingGravity - accelertion = gravity -->
<html>
    <head>
        <title>Version 1.4</title>
        <script type="text/javascript">

            let ballPosition = [250, 250];
            let ballVelocity = [0.0, 0.0];

            let acceleration = [0.0, 0.0, 0.0];
            let accelarationWithGravity = [0.0, 0.0, 0.0];
            let gravity = [0.0, 0.0, 0.0];

            let rotationCalibrationSamples = 0;
            let rotationCalibration = [0.0, 0.0, 0.0];
            let rotation = [0.0, 0.0, 0.0];

            let lastTime = null;

            let calibrateMode = false;

            const image = new Image(30, 392);
            image.src = "img/falcon9.jpg";

            function calibrate()
            {
                calibrateMode = true;

                setTimeout(function() {
                    calibrateMode = false;

                    rotationCalibration[0] /= rotationCalibrationSamples;
                    rotationCalibration[1] /= rotationCalibrationSamples;
                    rotationCalibration[2] /= rotationCalibrationSamples;

                    alert("" + rotationCalibration[0] + " " + rotationCalibration[1] + " " + rotationCalibration[2]);
                }, 10000);
            }

            function draw(time)
            {
                if (lastTime == null)
                {
                    lastTime = time;
                }

                let deltaTime = time - lastTime;
                let deltaTimeSec = deltaTime / 1000.0;
                lastTime = time;

                let canvas = document.querySelector("canvas");
                let context = canvas.getContext("2d");

                canvas.width = 500;
                canvas.height = 500;

                let x = canvas.width * 0.5;
                let y = canvas.height * 0.5;
                let width = image.width;
                let height = image.height;
                let angleInRadians = rotation[2] / 180.0 * Math.PI;

                context.translate(x, y);
                context.rotate(angleInRadians);
                context.drawImage(image, -width * 0.5, -height * 0.5, width, height);
                context.rotate(-angleInRadians);
                context.translate(-x, -y);

                window.requestAnimationFrame(draw);
            }

            window.addEventListener("devicemotion", function(e) {
                console.log(e);
                try
                {
                    acceleration[0] = e.acceleration.x;
                    acceleration[1] = e.acceleration.y;
                    acceleration[2] = e.acceleration.z;

                    accelarationWithGravity[0] = e.accelerationIncludingGravity.x;
                    accelarationWithGravity[1] = e.accelerationIncludingGravity.y;
                    accelarationWithGravity[2] = e.accelerationIncludingGravity.z;

                    gravity[0] = e.accelerationIncludingGravity.x - e.acceleration.x;
                    gravity[1] = e.accelerationIncludingGravity.y - e.acceleration.y;
                    gravity[2] = e.accelerationIncludingGravity.z - e.acceleration.z;

                    if (calibrateMode)
                    {
                        rotationCalibration[0] += e.rotationRate.alpha * e.interval;
                        rotationCalibration[1] += e.rotationRate.beta * e.interval;
                        rotationCalibration[2] += e.rotationRate.gamma * e.interval;

                        rotationCalibrationSamples += 1;
                    }
                    else
                    {
                        rotation[0] += e.rotationRate.alpha * e.interval / 1000.0 - rotationCalibration[0];
                        rotation[1] += e.rotationRate.beta * e.interval / 1000.0  - rotationCalibration[1];
                        rotation[2] -= e.rotationRate.gamma * e.interval / 1000.0 - rotationCalibration[2];
                    }
                }
                catch (e)
                {
                    document.querySelector("#error").innerText = e.message;
                }
            });

            window.addEventListener("load", function() {
                let canvas = document.querySelector("canvas");

                canvas.width = 500;
                canvas.height = 500;

                setInterval(function() {
                    document.querySelector("#ax").innerText = "X: " + acceleration[0].toFixed(2);
                    document.querySelector("#ay").innerText = "Y: " + acceleration[1].toFixed(2);
                    document.querySelector("#az").innerText = "Z: " + acceleration[2].toFixed(2);

                    document.querySelector("#agx").innerText = "X: " + accelarationWithGravity[0].toFixed(2);
                    document.querySelector("#agy").innerText = "Y: " + accelarationWithGravity[1].toFixed(2);
                    document.querySelector("#agz").innerText = "Z: " + accelarationWithGravity[2].toFixed(2);
                    document.querySelector("#ags").innerText = "S: " + Math.sqrt(accelarationWithGravity[0] * accelarationWithGravity[0] + accelarationWithGravity[1] * accelarationWithGravity[1] + accelarationWithGravity[2] * accelarationWithGravity[2])

                    document.querySelector("#x").innerText = "X: " + gravity[0].toFixed(2);
                    document.querySelector("#y").innerText = "Y: " + gravity[1].toFixed(2);
                    document.querySelector("#z").innerText = "Z: " + gravity[2].toFixed(2);

                    document.querySelector("#vx").innerText = "Y: " + ballVelocity[0].toFixed(2);
                    document.querySelector("#vy").innerText = "Z: " + ballVelocity[1].toFixed(2);

                    document.querySelector("#rx").innerText = "Xr: " + rotation[0].toFixed(2);
                    document.querySelector("#ry").innerText = "Yr: " + rotation[1].toFixed(2);
                    document.querySelector("#rz").innerText = "Zr: " + rotation[2].toFixed(2);
                }, 100);

                window.requestAnimationFrame(draw);
            });

        </script>

        <style>
            .container {
                display: flex;
                justify-content: center;
                align-items: center;

                font-size: 25px;
            }

            div {
                margin: 10px;
            }

            canvas {
                border: 2px solid #000;
                width: 500px;
                height: 500px;
            }
        </style>

    </head>
    <body>
        <div class="container">
            <div id="ax">
            </div>
            <div id="ay">
            </div>
            <div id="az">
            </div>
        </div>
        <div class="container">
            <div id="agx">
            </div>
            <div id="agy">
            </div>
            <div id="agz">
            </div>
            <div id="ags">
            </div>
        </div>
        <div class="container">
            <div id="x">
            </div>
            <div id="y">
            </div>
            <div id="z">
            </div>
        </div>
        <div class="container">
            <div id="vx">
            </div>
            <div id="vy">
            </div>
        </div>
        <div class="container">
            Rotation version 1.4
            <div id="rx">
            </div>
            <div id="ry">
            </div>
            <div id="rz">
            </div>
        </div>
        <div id="error">
        </div>
        <canvas>
        </canvas>
        <button onclick="calibrate();">Calibrate</button>
    </body>
</html>